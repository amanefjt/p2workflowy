# troubleshooting_log.md

## 2026-02-12: 初期セットアップ

### 現象
- リファクタリング開始に際して、管理用ドキュメントが存在しなかった。

### 原因
- 新規導入されたルールに基づく管理ドキュメントの欠如。

### 対策
- `docs/management/requirements_log.md` および `troubleshooting_log.md` を作成。

## 2026-02-12: LLM出力の品質管理（タグ混入とボールド化）

### 現象
- 構造復元や翻訳の出力に ` ```markdown ` などのコードブロックマーカーや `<thought>`、`<Ethnography>` などの内部タグが混入した。
- グロッサリーの訳語が `**用語**` のように勝手に太字にされる。
- 特定の英単語（例: `moment`）が `**"moment"**` のように不自然な形式で出力された。

### 原因
- LLMの思考プロセスや「良かれ」と思った強調表示が最終出力に漏れた。
- グロッサリーファイル内のエントリ `「場面」, “moment"` が `JP, EN` の形式になっており、翻訳時にLLMを混乱させた。
- **問題**: チャンク分割処理により、結合後の成果物に "# Introduction" などの主要見出しが重複して出現する。
    - **原因**: AIが各チャンクの文脈のみを見て、独立して見出しを付与してしまう。
    - **対策**: `src/skills.py` に、結合語のテキストから最初に出現する主要見出し以外を削除する後処理ロジックを実装。
- **問題**: 20ページ超の論文で後半が欠落する。
    - **原因**: 入力コンテキストは足りているが、LLMの出力トークン制限（8k/16k）を超えている。
    - **対策**: チャンクサイズを3.5万文字（約1万〜1.2万トークンの出力相当）に調整し、安全圏で分割処理を行う。
- **問題**: 参考文献や謝辞などの不要な翻訳が含まれる。
    - **原因**: 構造復元（Structuring）プロンプトの指示が不十分。
    - **対策**: `STRUCTURING_PROMPT` に明確な除外ルールを追加し、タイトル・要旨・本文・注のみを抽出対象とする。
- `skills.py` での後処理（クリーニング）が不十分（または未実装）だった。

## 2026-02-13: モデルの固定と処理効率の最適化

### 現象
- Gemini 1.5 Flash を前提とした小さなチャンクサイズ（4000文字）により、大規模な論文で並列リクエスト数が過剰になり、APIのレートリミットや管理の複雑さが増していた。
- UIにモデル選択肢があったが、ユーザーは `gemini-3-flash-preview` への固定を希望。

### 原因
- 旧世代のモデル（出力トークン制限 8k 程度）に合わせた保守的な分割設定。

### 対策
- **モデルの固定**: Python/Web両方で `gemini-3-flash-preview` をデフォルトかつ唯一の選択肢として固定。
- **チャンクサイズの最適化**: `gemini-3-flash-preview` の広大なコンテキスト（出力 64k）を活かし、チャンクサイズを `30,000` 文字に拡大。
    - これにより、ほとんどの論文は 1〜2 回のリクエストで完了し、コンテキストの維持と精度の向上が期待できる。
- **UIの簡素化**: プロ意識を高めるため、不要なモデル選択UIを削除し、APIキー設定のみのクリーンなインターフェースに変更。
- **ドキュメント化**: モデル性能に応じた設定調整方法を `docs/management/model_optimization.md` に集約。

### 対策
- `glossary.csv` の不整合エントリを修正（`moment, 場面`）。
- `skills.py` に `re` モジュールを用いた強力なクリーニング処理を実装。
    - Markdownコードブロックの除去。
    - 思考タグ (`<thought>`) の除去。
    - 不要なメタタグ (`<...>`）の除去。
    - 原文にない過剰なボールド化 (`**...**`) の除去。
- `translate_academic` メソッドに後処理フローを統合。

## 2026-02-13: 書籍モード実装中のコード重複とインデント問題

### 現象
- `src/main.py` の修正中に、誤って同名の関数 `_assemble_workflowy` が重複して定義され、さらに一部のロジックが誤ったインデントレベルで挿入された。これによりスクリプトが構文エラーとなった。

### 原因
- `multi_replace_file_content` の適用範囲設定の誤り、または不完全な置換によるもの。

### 対策
- `replace_file_content` を使用して、重複箇所と誤インデント箇所を特定し、ファイルを正しい構造にクリーンアップした。
- 今後は、大規模な置換の際は `view_file` で最終的な整合性を再度確認することを徹底する。

## 2026-02-14: サマリー出力のネスト（階層）問題

### 現象
- Workflowyに貼り付けると、「リサーチ・クエスチョン」「核心的主張」がタイトルの下位項目に入り、1階層余分にネストされていた。

### 原因
- `SUMMARY_PROMPT` / `BOOK_SUMMARY_PROMPT` の `<example>` セクションで「論文タイトル」「本タイトル」を親ラッパーとして配置していたため、AIがその構造を再現していた。

### 対策
- プロンプトのexampleを修正し、リサーチ・クエスチョン/核心的主張/各セクションを**並列（フラット）**構造に変更。
- ルールに「**同じ階層に配置すること。タイトルの下位項目にしないこと。**」を明示的に追加。

## 2026-02-14: BOOK_STRUCTURE_PROMPT キー名不一致とアンカーマッチング失敗

### 現象
- 書籍モードでPhase 2（アンカー検索による分割）が全章で失敗。「No anchor text」「Anchor not found」のWarningが出力される。

### 原因
1. `shared/prompts.json` から `BOOK_STRUCTURE_PROMPT` が削除されていた（Web版リファクタリングの副作用）。
2. プロンプトは `anchor` キーで出力するが、コード (`split_by_anchors`) は `start_text` キーを参照していた。
3. LLMが抽出したアンカーテキスト（空白正規化済み）と元のOCRテキスト（生の改行・空白）で表記が異なり、`str.find()` の完全一致が失敗。

### 対策
- `BOOK_STRUCTURE_PROMPT` を復元（TOC抽出のみに限定）。
- `anchor` / `start_text` 両方をフォールバックで対応。
- 3段階のファジーマッチングを実装: 完全一致 → 空白正規化 → 先頭N語部分一致。

## 2026-02-14: WorkFlowyでの章分裂（同一章が複数ノードになる）

### 現象
- 一つの章（例: "2. REGISTERS..."）が、翻訳処理の過程で分割され、WorkFlowy上で2つのトップレベルノードとして出力された。
- ユーザー報告: 「中身を見ると本文が二つに分割されている」「toc.txtは正しい」。

### 原因
- 長文の章が `translate_chapter` 内でチャンク分割され、並列翻訳された際、2つ目以降のチャンクの翻訳結果に H1 (`# 見出し`) が含まれていた。
- `markdown_to_workflowy` 変換時に、この内部的な H1 がトップレベルのノードとして解釈され、本来の親ノード（TOC由来のタイトル）から飛び出してしまった。

### 対策
- `BOOK_TRANSLATION_PROMPT` に「トップレベル見出し(#)の使用禁止（H2以下を使うこと）」というルールを追加。
- `skills.py` の `translate_chapter` メソッドにサニタイズ処理を追加: 翻訳結果に含まれる全ての H1 (`# `) を強制的に H2 (`## `) に正規表現置換。これにより、翻訳コンテンツが常に親章の下に収まることを保証。

## 2026-02-14: 翻訳テキストの重複・欠落とサマリー階層の修正

### 現象
1. **翻訳テキストの不整合**: 長文の章（例: "2. REGISTERS..."）で、本文の一部が欠落したり、同じ見出しが繰り返されたりする現象が発生。
2. **サマリー階層の深さ**: Chapter Summary において、「リサーチ・クエスチョン」の中に「核心的主張」がネストされるなど、階層が深すぎて一覧性が悪かった。

### 原因
1. **単純な長による分割**: `translate_chapter` が `_split_text_by_length`（文字数ベースの分割）を使用していたため、文脈を無視してテキストが切断されていた。また、AIが分割された断片の冒頭に勝手に見出しを補完することで重複が発生していた。
2. **プロンプトの例示**: `BOOK_CHAPTER_SUMMARY_PROMPT` の `<example>` がネスト構造になっており、AIがそれを忠実に再現していた。

### 対策
1. **意味的な分割への変更**: `translate_chapter` の分割ロジックを `_split_markdown_by_headers`（見出しベースの分割）に変更。構造化されたMarkdownのセクション単位で分割・翻訳することで、文脈の分断とAIによる勝手な補完を防止。
2. **フラット構造化**: `BOOK_CHAPTER_SUMMARY_PROMPT` を修正し、リサーチ・クエスチョン、核心的主張、各セクションの論理展開を**並列（兄弟要素）**として出力するように指示。

## 2026-02-14: 翻訳ロジックの改善と並列制御

### 目的
- `translate_chapter` (Book Mode) を `translate_academic` (Paper Mode) の品質基準に引き上げる。
- 大量の章セクションを並列翻訳する際のリクエスト過多を防ぐ。

### 実施内容
1.  **プロンプト注入の厳格化**: `.replace()` チェーンによる変数の埋め込みを、`translate_academic` と同様の明示的な処理に統一。`overall_summary`, `chapter_summary`, `glossary_content` が確実に反映されるように改善。
2.  **並列数の制御 (Semaphore)**: 章ごとの翻訳処理において、同時に実行されるチャンク翻訳タスクを **5** に制限する `asyncio.Semaphore(5)` を導入。これにより、大規模な章でもAPIレートリミットに抵触しにくくした。
3.  **エラーハンドリング**: 個別のチャンク翻訳エラーをキャッチし、ログ出力後に再スローする構造に整理。

## 2026-02-14: 構造化テキストのキャッシュ機能

### 目的
- 再実行時（リトライやデバッグ）の処理時間を短縮する。
- 構造化フェーズ（Structure）と翻訳フェーズ（Translate）を分離し、構造化の結果（英文OCRの整形品質）を単体で確認・修正できるようにする。

### 実施内容
- `main.py` の `process_single_chapter` を改修。
- `intermediate/chapters/chapXXX_structured.md` が存在する場合、AI処理をスキップしてそのファイルを読み込むロジックを追加。
- 存在しない場合は従来通りAI処理を行い、結果を同パスに保存するように変更。
- これにより、翻訳プロンプトだけの調整や一時的なネットワークエラーからの復帰が高速に行えるようになった。
