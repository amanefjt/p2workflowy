# troubleshooting_log.md

## 2026-02-12: 初期セットアップ

### 現象
- リファクタリング開始に際して、管理用ドキュメントが存在しなかった。

### 原因
- 新規導入されたルールに基づく管理ドキュメントの欠如。

### 対策
- `docs/management/requirements_log.md` および `troubleshooting_log.md` を作成。

## 2026-02-12: LLM出力の品質管理（タグ混入とボールド化）

### 現象
- 構造復元や翻訳の出力に ` ```markdown ` などのコードブロックマーカーや `<thought>`、`<Ethnography>` などの内部タグが混入した。
- グロッサリーの訳語が `**用語**` のように勝手に太字にされる。
- 特定の英単語（例: `moment`）が `**"moment"**` のように不自然な形式で出力された。

### 原因
- LLMの思考プロセスや「良かれ」と思った強調表示が最終出力に漏れた。
- グロッサリーファイル内のエントリ `「場面」, “moment"` が `JP, EN` の形式になっており、翻訳時にLLMを混乱させた。
- **問題**: チャンク分割処理により、結合後の成果物に "# Introduction" などの主要見出しが重複して出現する。
    - **原因**: AIが各チャンクの文脈のみを見て、独立して見出しを付与してしまう。
    - **対策**: `src/skills.py` に、結合語のテキストから最初に出現する主要見出し以外を削除する後処理ロジックを実装。
- **問題**: 20ページ超の論文で後半が欠落する。
    - **原因**: 入力コンテキストは足りているが、LLMの出力トークン制限（8k/16k）を超えている。
    - **対策**: チャンクサイズを3.5万文字（約1万〜1.2万トークンの出力相当）に調整し、安全圏で分割処理を行う。
- **問題**: 参考文献や謝辞などの不要な翻訳が含まれる。
    - **原因**: 構造復元（Structuring）プロンプトの指示が不十分。
    - **対策**: `STRUCTURING_PROMPT` に明確な除外ルールを追加し、タイトル・要旨・本文・注のみを抽出対象とする。
- `skills.py` での後処理（クリーニング）が不十分（または未実装）だった。

### 対策
- `glossary.csv` の不整合エントリを修正（`moment, 場面`）。
- `skills.py` に `re` モジュールを用いた強力なクリーニング処理を実装。
    - Markdownコードブロックの除去。
    - 思考タグ (`<thought>`) の除去。
    - 不要なメタタグ (`<...>`）の除去。
    - 原文にない過剰なボールド化 (`**...**`) の除去。
- `translate_academic` メソッドに後処理フローを統合。
