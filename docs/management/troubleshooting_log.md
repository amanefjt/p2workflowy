# troubleshooting_log.md

## 2026-02-12: 初期セットアップ

### 現象
- リファクタリング開始に際して、管理用ドキュメントが存在しなかった。

### 原因
- 新規導入されたルールに基づく管理ドキュメントの欠如。

### 対策
- `docs/management/requirements_log.md` および `troubleshooting_log.md` を作成。

## 2026-02-12: LLM出力の品質管理（タグ混入とボールド化）

### 現象
- 構造復元や翻訳の出力に ` ```markdown ` などのコードブロックマーカーや `<thought>`、`<Ethnography>` などの内部タグが混入した。
- グロッサリーの訳語が `**用語**` のように勝手に太字にされる。
- 特定の英単語（例: `moment`）が `**"moment"**` のように不自然な形式で出力された。

### 原因
- LLMの思考プロセスや「良かれ」と思った強調表示が最終出力に漏れた。
- グロッサリーファイル内のエントリ `「場面」, “moment"` が `JP, EN` の形式になっており、翻訳時にLLMを混乱させた。
- **問題**: チャンク分割処理により、結合後の成果物に "# Introduction" などの主要見出しが重複して出現する。
    - **原因**: AIが各チャンクの文脈のみを見て、独立して見出しを付与してしまう。
    - **対策**: `src/skills.py` に、結合語のテキストから最初に出現する主要見出し以外を削除する後処理ロジックを実装。
- **問題**: 20ページ超の論文で後半が欠落する。
    - **原因**: 入力コンテキストは足りているが、LLMの出力トークン制限（8k/16k）を超えている。
    - **対策**: チャンクサイズを3.5万文字（約1万〜1.2万トークンの出力相当）に調整し、安全圏で分割処理を行う。
- **問題**: 参考文献や謝辞などの不要な翻訳が含まれる。
    - **原因**: 構造復元（Structuring）プロンプトの指示が不十分。
    - **対策**: `STRUCTURING_PROMPT` に明確な除外ルールを追加し、タイトル・要旨・本文・注のみを抽出対象とする。
- `skills.py` での後処理（クリーニング）が不十分（または未実装）だった。

## 2026-02-13: モデルの固定と処理効率の最適化

### 現象
- Gemini 1.5 Flash を前提とした小さなチャンクサイズ（4000文字）により、大規模な論文で並列リクエスト数が過剰になり、APIのレートリミットや管理の複雑さが増していた。
- UIにモデル選択肢があったが、ユーザーは `gemini-3-flash-preview` への固定を希望。

### 原因
- 旧世代のモデル（出力トークン制限 8k 程度）に合わせた保守的な分割設定。

### 対策
- **モデルの固定**: Python/Web両方で `gemini-3-flash-preview` をデフォルトかつ唯一の選択肢として固定。
- **チャンクサイズの最適化**: `gemini-3-flash-preview` の広大なコンテキスト（出力 64k）を活かし、チャンクサイズを `30,000` 文字に拡大。
    - これにより、ほとんどの論文は 1〜2 回のリクエストで完了し、コンテキストの維持と精度の向上が期待できる。
- **UIの簡素化**: プロ意識を高めるため、不要なモデル選択UIを削除し、APIキー設定のみのクリーンなインターフェースに変更。
- **ドキュメント化**: モデル性能に応じた設定調整方法を `docs/management/model_optimization.md` に集約。

### 対策
- `glossary.csv` の不整合エントリを修正（`moment, 場面`）。
- `skills.py` に `re` モジュールを用いた強力なクリーニング処理を実装。
    - Markdownコードブロックの除去。
    - 思考タグ (`<thought>`) の除去。
    - 不要なメタタグ (`<...>`）の除去。
    - 原文にない過剰なボールド化 (`**...**`) の除去。
- `translate_academic` メソッドに後処理フローを統合。

## 2026-02-13: 書籍モード実装中のコード重複とインデント問題

### 現象
- `src/main.py` の修正中に、誤って同名の関数 `_assemble_workflowy` が重複して定義され、さらに一部のロジックが誤ったインデントレベルで挿入された。これによりスクリプトが構文エラーとなった。

### 原因
- `multi_replace_file_content` の適用範囲設定の誤り、または不完全な置換によるもの。

### 対策
- `replace_file_content` を使用して、重複箇所と誤インデント箇所を特定し、ファイルを正しい構造にクリーンアップした。
- 今後は、大規模な置換の際は `view_file` で最終的な整合性を再度確認することを徹底する。

## 2026-02-14: サマリー出力のネスト（階層）問題

### 現象
- Workflowyに貼り付けると、「リサーチ・クエスチョン」「核心的主張」がタイトルの下位項目に入り、1階層余分にネストされていた。

### 原因
- `SUMMARY_PROMPT` / `BOOK_SUMMARY_PROMPT` の `<example>` セクションで「論文タイトル」「本タイトル」を親ラッパーとして配置していたため、AIがその構造を再現していた。

### 対策
- プロンプトのexampleを修正し、リサーチ・クエスチョン/核心的主張/各セクションを**並列（フラット）**構造に変更。
- ルールに「**同じ階層に配置すること。タイトルの下位項目にしないこと。**」を明示的に追加。

## 2026-02-14: BOOK_STRUCTURE_PROMPT キー名不一致とアンカーマッチング失敗

### 現象
- 書籍モードでPhase 2（アンカー検索による分割）が全章で失敗。「No anchor text」「Anchor not found」のWarningが出力される。

### 原因
1. `shared/prompts.json` から `BOOK_STRUCTURE_PROMPT` が削除されていた（Web版リファクタリングの副作用）。
2. プロンプトは `anchor` キーで出力するが、コード (`split_by_anchors`) は `start_text` キーを参照していた。
3. LLMが抽出したアンカーテキスト（空白正規化済み）と元のOCRテキスト（生の改行・空白）で表記が異なり、`str.find()` の完全一致が失敗。

### 対策
- `BOOK_STRUCTURE_PROMPT` を復元（TOC抽出のみに限定）。
- `anchor` / `start_text` 両方をフォールバックで対応。
- 3段階のファジーマッチングを実装: 完全一致 → 空白正規化 → 先頭N語部分一致。

## 2026-02-14: WorkFlowyでの章分裂（同一章が複数ノードになる）

### 現象
- 一つの章（例: "2. REGISTERS..."）が、翻訳処理の過程で分割され、WorkFlowy上で2つのトップレベルノードとして出力された。
- ユーザー報告: 「中身を見ると本文が二つに分割されている」「toc.txtは正しい」。

### 原因
- 長文の章が `translate_chapter` 内でチャンク分割され、並列翻訳された際、2つ目以降のチャンクの翻訳結果に H1 (`# 見出し`) が含まれていた。
- `markdown_to_workflowy` 変換時に、この内部的な H1 がトップレベルのノードとして解釈され、本来の親ノード（TOC由来のタイトル）から飛び出してしまった。

### 対策
- `BOOK_TRANSLATION_PROMPT` に「トップレベル見出し(#)の使用禁止（H2以下を使うこと）」というルールを追加。
- `skills.py` の `translate_chapter` メソッドにサニタイズ処理を追加: 翻訳結果に含まれる全ての H1 (`# `) を強制的に H2 (`## `) に正規表現置換。これにより、翻訳コンテンツが常に親章の下に収まることを保証。

## 2026-02-14: 翻訳テキストの重複・欠落とサマリー階層の修正

### 現象
1. **翻訳テキストの不整合**: 長文の章（例: "2. REGISTERS..."）で、本文の一部が欠落したり、同じ見出しが繰り返されたりする現象が発生。
2. **サマリー階層の深さ**: Chapter Summary において、「リサーチ・クエスチョン」の中に「核心的主張」がネストされるなど、階層が深すぎて一覧性が悪かった。

### 原因
1. **単純な長による分割**: `translate_chapter` が `_split_text_by_length`（文字数ベースの分割）を使用していたため、文脈を無視してテキストが切断されていた。また、AIが分割された断片の冒頭に勝手に見出しを補完することで重複が発生していた。
2. **プロンプトの例示**: `BOOK_CHAPTER_SUMMARY_PROMPT` の `<example>` がネスト構造になっており、AIがそれを忠実に再現していた。

### 対策
1. **意味的な分割への変更**: `translate_chapter` の分割ロジックを `_split_markdown_by_headers`（見出しベースの分割）に変更。構造化されたMarkdownのセクション単位で分割・翻訳することで、文脈の分断とAIによる勝手な補完を防止。
2. **フラット構造化**: `BOOK_CHAPTER_SUMMARY_PROMPT` を修正し、リサーチ・クエスチョン、核心的主張、各セクションの論理展開を**並列（兄弟要素）**として出力するように指示。

## 2026-02-14: 翻訳ロジックの改善と並列制御

### 目的
- `translate_chapter` (Book Mode) を `translate_academic` (Paper Mode) の品質基準に引き上げる。
- 大量の章セクションを並列翻訳する際のリクエスト過多を防ぐ。

### 実施内容
1.  **プロンプト注入の厳格化**: `.replace()` チェーンによる変数の埋め込みを、`translate_academic` と同様の明示的な処理に統一。`overall_summary`, `chapter_summary`, `glossary_content` が確実に反映されるように改善。
2.  **並列数の制御 (Semaphore)**: 章ごとの翻訳処理において、同時に実行されるチャンク翻訳タスクを **5** に制限する `asyncio.Semaphore(5)` を導入。これにより、大規模な章でもAPIレートリミットに抵触しにくくした。
3.  **エラーハンドリング**: 個別のチャンク翻訳エラーをキャッチし、ログ出力後に再スローする構造に整理。

## 2026-02-14: 構造化テキストのキャッシュ機能

### 目的
- 再実行時（リトライやデバッグ）の処理時間を短縮する。
- 構造化フェーズ（Structure）と翻訳フェーズ（Translate）を分離し、構造化の結果（英文OCRの整形品質）を単体で確認・修正できるようにする。

### 実施内容
- `main.py` の `process_single_chapter` を改修。
- `intermediate/chapters/chapXXX_structured.md` が存在する場合、AI処理をスキップしてそのファイルを読み込むロジックを追加。
- **(追記)** ユーザー要望により、既存ファイルがあっても読み込まず、常に新規生成して上書き保存するように変更。
- これにより、常に最新のAIモデルで構造化を行いつつ、中間生成物（構造化済みテキスト）を確認・デバッグ用に保存することが可能になった。

## 2026-02-14: 要約ファイルの出力先変更

### 目的
- 成果物フォルダ（Downloadsなど）の混雑を避け、重要なファイル（最終出力と構造化英文）のみを残す。
- 要約は中間データとしての側面が強いため、`intermediate` ディレクトリに整理する。

### 実施内容
- `main.py` の `main()` 関数において、`output_summary` の定義を `input_file.parent` から `inter_dir` に変更。
- 論文モード (`_process_paper`) と書籍モード (`_process_book`) の両方に適用。
- 処理完了時のコンソール表示も自動的に新しいパスを指すように修正。

## 2026-02-14: Utils.py におけるインデントエラーとメソッド消失

### 現象
- `sanitize_filename` メソッドを追加する際、`replace_file_content` の範囲指定ミスにより、既存の `split_text_into_chunks` メソッドの末尾にあった `return` 文が削除され、かつ新規追加メソッドのインデントが崩れて実行エラーとなった。

### 原因
- `TargetContent` に指定した文字列が、メソッド内の最後に位置していたため、意図せずメソッドの一部を上書きしてしまった。

### 対策
- `view_file` で行番号を正確に確認し、削除された `return` 文を復元しつつ、クラスメソッドとして正しいインデント位置に `sanitize_filename` を配置し直した。
- 今後は、メソッドの追加や変更の際、既存の構造を壊さないよう、境界部分（空行など）を含めた慎重な範囲指定を行う。

## 2026-02-14: AIによるヘッダーおよびIntroductionの幻覚（ハルシネーション）

### 現象
- AIがプレーンテキストに存在しない章タイトル（`# Title`）や、文中の不自然な位置に `## Introduction` を勝手に挿入してしまい、最終的なWorkflowyの階層構造が崩れる。

### 原因
- LLMが文脈を補完しようとして、特に中見出しの前などに既存の見出しを勝手に再生成してしまう。プロンプトでの抑制だけでは不十分な場合がある。

### 対策
- 強制的な後処理ロジック `removeRedundantHeaders` を実装し、最終出力直前に適用。
    - 2回目以降に出現するレベル1見出し（`# `）を削除。
    - 30行目以降に出現する `## Introduction`（大文字小文字問わず）を削除。
- 論文モード（全体結合後）と書籍モード（各章の翻訳後）の両方に統合。
- **Python側の根本修正**: `skills.py` の `structure_chapter` メソッド（書籍モード用）の返却値にも `Utils.sanitize_structured_output` を適用。論文モード用の `structure_text_with_hint` では既に適用済みだったが、書籍モードでは適用漏れがあり、中間ファイルにハルシネーションが残存していた。

## 2026-02-14: 論文モード構造化で後半の節が欠落する

### 現象
- 8節ある論文（67KB）で、構造化された英語ファイル (`_structured_eng.md`) に2節しか含まれず、後半6節が欠落。
- 要約 (`_output.txt`) では8節すべてが正しく認識されていた。

### 原因
- `structure_text_with_hint` が67KBの全文を**1回のAPI呼び出し**で処理しており、モデルの出力トークン制限に到達してレスポンスが途中で打ち切られた。
- 書籍モードの `structure_chapter` には既に `_split_text_by_length` によるチャンク分割+並列処理が実装されていたが、論文モードには未適用だった。

### 対策
- `structure_text_with_hint` に書籍モードと同様のチャンク分割+`asyncio.gather` 並列処理を実装。
- `MAX_TRANSLATION_CHUNK_SIZE`（40,000文字）を基準にテキストを分割し、各チャンクを独立してAPI呼び出し→結果を結合→サニタイズの流れに変更。

## 2026-02-14: 翻訳出力へのAIの「ひとりごと（自問自答）」の混入

### 現象
- 翻訳結果 (`_output.txt`) の中に、「はい、翻訳しました」「矛盾があるようですが、原文に集中します」といったAIのメタ発言や、長文の自問自答（内省プロセス）が混入する。
- 特に、論文の内容と提供された `glossary.csv` が明らかに別物である場合に顕著に発生。

### 原因
- LLMが提示された[Context/Glossary]と[Target Text]の矛盾を検知した際、その不整合について「報告」したり、どう処理すべきか「自問自答」したりした内容が、フィルタリングされずに出力されてしまった。

### 対策
1.  **プロンプトの厳格化**:
    - `TRANSLATION_PROMPT` および `BOOK_TRANSLATION_PROMPT` に、「矛盾を無視して翻訳にのみ集中せよ」「メタ発言を一切禁止する」というルールを明文化。
2.  **事後サニタイズの実装**:
    - `Utils.sanitize_translated_output` メソッドを追加。AI特有の開始・終了フレーズ（「はい、翻訳しました」「どうぞ」等）や、矛盾に関する特定の言い回しを正規表現で検知し、行単位で削除する。
3.  **パイプラインへの統合**:
    - `skills.py` の各種翻訳メソッドにおいて、LLMからのレスポンスを直接返さず、必ず `Utils.sanitize_translated_output` を経由してから返すように修正。

## 2026-02-14: translate_chapter メソッドの消失

### 現象
- 書籍モード (`Book Mode`) の実行時に `AttributeError: 'PaperProcessorSkills' object has no attribute 'translate_chapter'` が発生し、処理が中断された。

### 原因
- `skills.py` のリ構想（リファクタリング）時に、`structure_text_with_hint` と `structure_chapter` を共通化する変更を行った際、`replace_file_content` の範囲指定ミスにより、直下の `translate_chapter` メソッドを誤って削除してしまった。

### 対策
- 削除された `translate_chapter` メソッドを復元し、正常に動作することを確認した。

## 2026-02-14: Workspace Cleanup (Data and Prompt Redundancy)

### 現象
- ルートディレクトリに過去の試行錯誤によるテストスクリプト (`test_*.py`) や中間生成物が散乱していた。
- `shared/prompts.json` に、現在は使用されていない旧式の `STRUCTURING_PROMPT` が残っており、保守性を損なっていた。
- `intermediate/` フォルダが過去の巨大な書籍処理データで肥大化していた。

### 原因
- 頻繁なリファクタリングとデバッグの過程で生成された一時ファイルが、明示的に削除・整理されずに残存していた。

### 対策
1.  **テストファイルの移動**: ルートの `test_*.py` を全て `tests/` に移動。
2.  **中間データのアーカイブ**: `intermediate/` 内の全ファイルを、日付スタンプ付きの `archive` フォルダに退避。
3.  **不要プロンプトの削除**: コードから参照されていない `STRUCTURING_PROMPT` を `shared/prompts.json` から削除。
4.  **ルートの整理**: 出力サンプルなどを `output/` に移動、または不要なものを削除。

## 2026-02-15: Paper Mode 実行時の AttributeError
### 現象
- Paper Mode での要約フェーズ（Phase 1）において、`AttributeError` が発生しプログラムが停止する。
### 原因
- `src/main.py` で `skills.summarize_paper` を呼ぶべき箇所で、存在しない古いメソッド名が指定されていた。
### 対策
- `src/main.py` を修正し、`skills.py` で定義されている正しいメソッド名 `summarize_paper` を使用するようにした。

## 2026-02-15: Book Mode でのメモリ不足と非効率な再処理
### 現象
- 大規模な書籍（数百ページ）を処理する際、メモリ使用量が増大し不安定になる。
- 途中でエラーが発生した際、分割からやり直す必要があり時間がかかる。
### 原因
- 分割された章データをすべてメモリ上のオブジェクトとして保持していた。
- 中間データがディスクに保存されていなかったため、再利用が困難だった。
### 対策
- `Phase 2` で分割した直後に各章を `intermediate/chapters/chapXXX.txt` に保存し、メモリを解放する仕組みを導入。
- 各フェーズで中間ファイル（要約、構造化、翻訳）を章ごとに保存するようにし、進捗の可視化とデバッグを容易にした。

## 2026-02-15: Paper Mode の処理が長時間停止する（ハングアップの疑い）
### 現象
- Paper Mode の Phase 3（並列翻訳）において、処理が15分以上経過しても完了せず、コンソールに何の反応もなかったため、ユーザーが処理を中断した。

### 原因
- 翻訳対象のセクションが多い（今回は11個）場合、Gemini API へのリクエストに時間がかかる（数分単位）ことがある。
- 元のコードでは、セクションごとの翻訳進捗をコンソールに出力する仕組みがなかったため、処理が動いているのかハングアップしているのか、外部から判断できなかった。

### 対策
- `src/skills.py` の `translate_academic` メソッドに、チャンクごとの翻訳開始と完了を通知する `print` ログを追加。
- これにより、「どのチャンクを処理中か」「いくつ完了したか」がリアルタイムで見えるようになり、ユーザーが安心して待機できるようになった。
- 実際にログ付きで再実行したところ、全11チャンクが約5分で正常に完了することを確認した。
## 2026-02-15: テスト実行時の ModuleNotFoundError (src module)

### 現象
- `tests/` 配下のスクリプトを実行しようとすると、`ModuleNotFoundError: No module named 'src'` が発生する。

### 原因
- 実行時のカレントディレクトリがプロジェクトルートであっても、Python が `src` ディレクトリをパッケージとして認識していない、または `sys.path` に含まれていない。

### 対策
- 実行時に `PYTHONPATH=.` を指定して、ルートディレクトリを検索パスに含めるようにした。
- 例: `PYTHONPATH=. python3 tests/test_new_sanitize.py`

## 2026-02-15: Utils.py における load_glossary 等のメソッド欠落

### 現象
- `main.py` の実行時に `AttributeError: type object 'Utils' has no attribute 'load_glossary'` が発生。

### 原因
- 過去のリファクタリング過程で、`src/utils.py` から `load_glossary` および `markdown_to_workflowy` メソッドが消失していた。

### 対策
- `src/utils.py` に `load_glossary` と `markdown_to_workflowy` を再実装。
- `load_glossary`: CSVを読み込みプロンプト用の文字列に変換。
- `markdown_to_workflowy`: 見出し構造を Workflowy のインデント形式に変換。
- `verify_fixes.py` による単体テストで動作を確認済み。
## 2026-02-16: レジュメ（_resume.txt）が生成されない
**現象**: 処理完了後、これまで出力されていた `_resume.txt` が生成されない。
**原因**: ワークスペース整理のため、個別ファイルとしての出力は廃止されました。
**解決策/確認方法**: 
- **最終成果物を確認**: `_output.txt` (Workflowy形式) の一番最初のセクションとしてレジュメが含まれています。
- 単体ファイルが必要な場合は、`_output.txt` からコピーするか、必要に応じて `src/main.py` の `Utils.write_text_file(output_resume, resume_text)` のコメントアウト（あるいは削除した行）を復元してください。
## 2026-02-16: ドキュメントと実際のコードの乖離解消
### 現象
- `docs/manual.md` や `.agent/skills/p2workflowy_pipeline.md` が、既に削除（リバート）された書籍モードや以前の分割ロジックを説明しており、新しく参加した開発者やエージェントを混乱させる可能性があった。

### 原因
- 急激なリファクタリングと大幅な機能リバート（Book Mode の一時廃止）に対し、関連ドキュメントの更新が追いついていなかった。

### 対策
- 全ドキュメントを現状のコード（Paper Mode 集中、見出しベースの階層的分割 v2.1）に合わせて書き直した。
- 不要な実験的メソッド（サニタイズ系）を `src/utils.py` から一度削除し、シンプルな構造に戻した。
- 今後、大規模な機能追加や修正を行う際は、実装完了と同時に `vX.X` としてドキュメントも同期更新することをルール化する。
